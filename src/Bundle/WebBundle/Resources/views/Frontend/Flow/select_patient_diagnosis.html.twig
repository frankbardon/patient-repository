{# This file is part of the Accard package. #}

{# (c) University of Pennsylvania #}

{# For the full copyright and license information, please view the LICENSE #}
{# file that was distributed with this source code. #}

{% extends 'AccardWebBundle:Frontend/Flow:layout.html.twig' %}

{% from 'AccardWebBundle:Common/Macros:alerts.html.twig' import no_javascript %}
{% from 'AccardWebBundle:Common/Macros:form.html.twig' import select_patient, select_diagnosis, select_patient_js, select_patient_css %}

{% block flow_content %}
    {{ form_errors(form) }}    
    <div class="row">
        <div class="col-md-6">
            {{ select_patient(form.patient) }}
        </div>
        <div class="col-md-6">
            {{ select_diagnosis(form.diagnosis) }}
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ select_patient_js('#form_patient') }}
{% endblock %}

{% block page_javascripts %}
<script type="text/javascript">
    $('#form_patient').on('change', function(event) {
        var field = $('#form_diagnosis');
        field.find('option').remove();

        if (!event.added.id) {            
            return;
        }

        var urlClass = window.Accard.get('url');
        var url = new urlClass('{{ path('accard_api_patient_diagnoses', { patient: 99999 }) }}')
            .popSegment()
            .popSegment()
            .appendSegment(event.added.id)
            .appendSegment('diagnoses')
            .toString();

        field.prop('readonly', true);

        $.getJSON(url, function(diagnoses) {
            $(diagnoses).each(function(index, diagnosis) {
                field.append($('<option value="'+diagnosis.id+'">'+diagnosis.canonical+'</option>'));
            })
            field.prop('readonly', false);
        })
    });
</script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ select_patient_css() }}
{% endblock %}
