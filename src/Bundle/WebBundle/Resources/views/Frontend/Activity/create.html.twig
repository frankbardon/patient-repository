{# This file is part of the Accard package. #}

{# (c) University of Pennsylvania #}

{# For the full copyright and license information, please view the LICENSE #}
{# file that was distributed with this source code. #}


{% extends app.request.isXMLHttpRequest() ? 'AccardWebBundle:Frontend:no_layout.html.twig' : 'AccardWebBundle:Frontend:layout.html.twig' %}

{% from 'AccardWebBundle:Common/Macros:actions.html.twig' import create %}
{% from 'AccardWebBundle:Common/Macros:misc.html.twig' import page_title %}
{% from 'AccardWebBundle:Common/Macros:buttons.html.twig' import generic %}
{% from 'AccardWebBundle:Common/Macros:alerts.html.twig' import no_javascript %}
{% from 'AccardWebBundle:Common/Macros:form.html.twig' import select_patient_js, select_patient_css %}

{% set activity = form.vars.value %}
{% set prototype = activity.prototype is defined ? activity.prototype.name : 'default' %}

{% block content %}
    {% block page_title %}
        {{ page_title('accard.activity.action.create'|trans,
            [
                generic(path('accard_frontend_activity_index'), 'accard.activity.action.manage'|trans, 'user')
            ]
        ) }}
    {% endblock %}

    {% block activity_form %}
        {{ no_javascript() }}
        {{ form_errors(form) }}

        {% set createPath = path('accard_frontend_activity_create', { prototype: prototype }) %}
        {% if activity and activity.diagnosis %}
            {% set createPath = path('accard_frontend_activity_create', { prototype: prototype, diagnosis: activity.diagnosis.id }) %}
        {% elseif activity and activity.patient %}
            {% set createPath = path('accard_frontend_activity_create', { prototype: prototype, patient: activity.patient.id }) %}
        {% endif %}

        <form action="{{ createPath }}" method="post" {{ form_enctype(form) }}>
            {{ form_widget(form._token) }}
            {% include ["Theme:Frontend/Activity:#{prototype}-form.html.twig", "AccardWebBundle:Frontend/Activity:form.html.twig"] %}

            <div class="row">
                <div class="col-md-12">
                    <span class="pull-right">{{ create() }}</span>
                </div>
            </div>
        </form>
    {% endblock %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ select_patient_js('#accard_activity_patient') }}
{% endblock %}

{% block page_javascripts %}
    <script type="text/javascript">
        $('#accard_activity_patient').on('change', function(event) {
            var field = $('#accard_activity_diagnosis');
            field.find('option').remove();

            if (!event.added.id) {
                return;
            }

            var urlClass = window.Accard.get('url');
            var url = new urlClass('{{ path('accard_api_patient_diagnoses', { patient: 99999 }) }}')
                .popSegment()
                .popSegment()
                .appendSegment(event.added.id)
                .appendSegment('diagnoses')
                .toString();

            field.prop('readonly', true);

            $.getJSON(url, function(diagnoses) {
                $(diagnoses).each(function(index, diagnosis) {
                    field.append($('<option value="'+diagnosis.id+'">'+diagnosis.canonical+'</option>'));
                })
                field.prop('readonly', false);
            })
        });
    </script>

    {% include "Theme:Frontend/Activity:#{prototype}-javascript.js.twig" ignore missing %}

{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ select_patient_css() }}

    {% include "Theme:Frontend/Activity:#{prototype}-style.css.twig" ignore missing %}
{% endblock %}