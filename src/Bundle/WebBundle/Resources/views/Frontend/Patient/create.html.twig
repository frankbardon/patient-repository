{# This file is part of the Accard package. #}

{# (c) University of Pennsylvania #}

{# For the full copyright and license information, please view the LICENSE #}
{# file that was distributed with this source code. #}

{% extends 'AccardWebBundle:Frontend:layout.html.twig' %}

{% from 'AccardWebBundle:Common/Macros:actions.html.twig' import create %}
{% from 'AccardWebBundle:Common/Macros:misc.html.twig' import page_title %}
{% from 'AccardWebBundle:Common/Macros:buttons.html.twig' import generic %}

{% set settings = accard_settings('patient') %}
{% set pds = settings.pds_enabled is defined and settings.pds_enabled %}

{% block content %}
    {% block dpage_title %}
        {{ page_title('accard.patient.action.create'|trans,
            [
                generic(path('accard_frontend_patient_index'), 'accard.patient.action.manage'|trans, 'user')
            ]
        ) }}
    {% endblock %}

    {% block patient_form %}
        {{ form_errors(form) }}
        
        <form action="{{ path('accard_frontend_patient_create') }}" method="post" {{ form_enctype(form) }}>
            {{ form_widget(form._token) }}
            {% include 'Theme:Frontend/Patient:form.html.twig' %}
            <div class="row">
                <div class="col-md-12">
                    <span class="pull-right">{{ create() }}</span>
                </div>
            </div>
        </form>
    {% endblock %}
{% endblock %}

{% block page_javascripts -%}
    {% if pds %}<script type="text/javascript" src="{{ path('accard_pds_js') }}"></script>{% endif %}
    <script type="text/javascript">
        var formClass = Accard.get('form');
        var manager = new formClass('form');
        var addPhase = $('#add-phase').hide();

        $('a[data-toggle="tab"]').on('shown.bs.tab', function(event) {
            if (event.target.href.indexOf('patient-phase') != -1) {
                addPhase.fadeIn();
            } else {
                addPhase.fadeOut();
            }
        });

        function makeToday() {
            var now = new Date();
            var day = ("0" + now.getDate()).slice(-2);
            var month = ("0" + now.getMonth()).slice(-2);

            return now.getFullYear() + "-" + (month) + "-" + (day);
        }

        manager
            .plugin("pds", "#pds")
            .collection("#phases", {
                adder: addPhase,
                startup: function(collection) {
                    var field = $(this).find('input[type="date"]').first();

                    if (!field.val()) field.val(makeToday());
                    $(this).on('click', '.input-group-addon', function(event) {
                        var prev = $(this).prev();
                        $(prev).val(makeToday());
                    });
                }
            })
           .bindAll()
        ;
    </script>
{% endblock %}